<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üìù Todo App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }
        
        h1 {
            font-size: 3em;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .subtitle {
            font-size: 1.2em;
            margin-bottom: 40px;
            opacity: 0.9;
        }
        
        .card {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 15px;
            margin: 20px 0;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .status-item {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .status-item h3 {
            margin-bottom: 10px;
            color: #4ecdc4;
        }
        
        .api-section {
            text-align: left;
            margin: 30px 0;
        }
        
        button {
            background: #4ecdc4;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s, transform 0.2s;
        }
        
        button:hover {
            background: #45b7aa;
            transform: translateY(-2px);
        }
        
        .response {
            background: rgba(0,0,0,0.2);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
            text-align: left;
            white-space: pre-wrap;
        }
        
        input, textarea {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 16px;
            background: rgba(255,255,255,0.9);
            color: #333;
        }
        
        .footer {
            margin-top: 50px;
            opacity: 0.7;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìù Todo App</h1>
        <p class="subtitle">Manage your tasks efficiently</p>
        
        <div class="card">
            <h2>‚ú® Add New Todo</h2>
            <form id="todo-form" enctype="multipart/form-data" style="display: flex; flex-direction: column; gap: 15px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="text" id="new-todo-input" placeholder="Enter a new todo..." style="flex: 1;" required>
                    <button type="submit">‚ûï Add</button>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <label for="photo-input" style="color: white; font-size: 16px;">üì∑ Photo (optional JPEG):</label>
                    <input type="file" id="photo-input" accept="image/jpeg" style="flex: 1;">
                </div>
                <div id="photo-preview" style="display: none;">
                    <img id="preview-image" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin-top: 10px;">
                </div>
            </form>
        </div>
        
        <div class="card">
            <h2>üìã Your Todos</h2>
            <div id="todos-container">
                Loading todos...
            </div>
        </div>
        
        <div class="card">
            <h2>üìä Stats</h2>
            <div class="status">
                <div class="status-item">
                    <h3>üìù Total</h3>
                    <p id="total-count">0</p>
                </div>
                <div class="status-item">
                    <h3>‚úÖ Completed</h3>
                    <p id="completed-count">0</p>
                </div>
                <div class="status-item">
                    <h3>‚è≥ Pending</h3>
                    <p id="pending-count">0</p>
                </div>
                <div class="status-item">
                    <h3>üéØ Progress</h3>
                    <p id="progress-percent">0%</p>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>üéÆ Built with the Vibe Coding workflow</p>
            <p>üåü Deployed via Humanitec to GCP</p>
        </div>
    </div>

    <script>
        let todos = [];
        
        // Load todos on page load
        window.addEventListener('load', loadTodos);
        
        async function loadTodos() {
            try {
                const response = await fetch('/api/todos');
                todos = await response.json();
                renderTodos();
                updateStats();
            } catch (error) {
                console.error('Failed to load todos:', error);
            }
        }
        
        async function addTodo(event) {
            if (event) event.preventDefault();
            
            const textInput = document.getElementById('new-todo-input');
            const photoInput = document.getElementById('photo-input');
            const text = textInput.value.trim();
            
            if (!text) {
                alert('Please enter a todo!');
                return;
            }
            
            try {
                const formData = new FormData();
                formData.append('text', text);
                
                if (photoInput.files[0]) {
                    formData.append('photo', photoInput.files[0]);
                }
                
                const response = await fetch('/api/todos', {
                    method: 'POST',
                    body: formData
                });
                
                if (response.ok) {
                    textInput.value = '';
                    photoInput.value = '';
                    document.getElementById('photo-preview').style.display = 'none';
                    loadTodos();
                } else {
                    const error = await response.json();
                    alert('Failed to add todo: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Failed to add todo:', error);
                alert('Failed to add todo');
            }
        }
        
        // Photo preview functionality
        document.addEventListener('DOMContentLoaded', function() {
            const photoInput = document.getElementById('photo-input');
            const preview = document.getElementById('photo-preview');
            const previewImage = document.getElementById('preview-image');
            const todoForm = document.getElementById('todo-form');
            
            photoInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (file.type !== 'image/jpeg') {
                        alert('Please select a JPEG image file.');
                        photoInput.value = '';
                        preview.style.display = 'none';
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        previewImage.src = e.target.result;
                        preview.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                } else {
                    preview.style.display = 'none';
                }
            });
            
            todoForm.addEventListener('submit', addTodo);
        });
        
        async function toggleTodo(id, completed) {
            try {
                const response = await fetch(`/api/todos/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ completed })
                });
                
                if (response.ok) {
                    loadTodos();
                }
            } catch (error) {
                console.error('Failed to toggle todo:', error);
            }
        }
        
        async function deleteTodo(id) {
            if (!confirm('Are you sure you want to delete this todo?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/todos/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadTodos();
                }
            } catch (error) {
                console.error('Failed to delete todo:', error);
            }
        }
        
        async function renderTodos() {
            const container = document.getElementById('todos-container');
            
            if (todos.length === 0) {
                container.innerHTML = '<p style="opacity: 0.7; text-align: center; padding: 20px;">No todos yet. Add one above!</p>';
                return;
            }
            
            const todoElements = await Promise.all(todos.map(async (todo) => {
                let photoHtml = '';
                
                if (todo.hasPhoto) {
                    try {
                        const photoResponse = await fetch(`/api/todos/${todo.id}/photo`);
                        if (photoResponse.ok) {
                            const { photoUrl } = await photoResponse.json();
                            photoHtml = `
                                <div style="margin-left: 35px; margin-top: 10px;">
                                    <img src="${photoUrl}" 
                                         style="max-width: 150px; max-height: 100px; border-radius: 8px; cursor: pointer;"
                                         onclick="showFullPhoto('${photoUrl}', '${todo.text.replace(/'/g, "\\'")}')">
                                    <button onclick="deletePhoto(${todo.id})" 
                                            style="background: #ff6b6b; padding: 4px 8px; font-size: 12px; margin-left: 10px;">
                                        üóëÔ∏è Remove Photo
                                    </button>
                                </div>
                            `;
                        }
                    } catch (error) {
                        console.error('Failed to load photo for todo', todo.id, error);
                    }
                }
                
                return `
                    <div style="padding: 15px; margin: 10px 0; background: rgba(255,255,255,0.1); border-radius: 10px; ${todo.completed ? 'opacity: 0.6;' : ''}">
                        <div style="display: flex; align-items: center; justify-content: space-between;">
                            <div style="display: flex; align-items: center; gap: 15px; flex: 1;">
                                <input type="checkbox" ${todo.completed ? 'checked' : ''} 
                                       onchange="toggleTodo(${todo.id}, this.checked)"
                                       style="width: 20px; height: 20px; cursor: pointer;">
                                <span style="font-size: 18px; ${todo.completed ? 'text-decoration: line-through;' : ''}">${todo.text}</span>
                                ${todo.hasPhoto ? '<span style="margin-left: 10px;">üì∑</span>' : ''}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                ${!todo.hasPhoto ? `<button onclick="addPhotoToTodo(${todo.id})" style="background: #4ecdc4; padding: 8px 12px; font-size: 14px;">üì∑ Add Photo</button>` : ''}
                                <button onclick="deleteTodo(${todo.id})" 
                                        style="background: #ff4757; padding: 8px 12px; font-size: 14px;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </div>
                        ${photoHtml}
                    </div>
                `;
            }));
            
            container.innerHTML = todoElements.join('');
        }
        
        // Show full size photo in a modal
        function showFullPhoto(photoUrl, todoText) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.9); display: flex; align-items: center;
                justify-content: center; z-index: 1000; cursor: pointer;
            `;
            
            modal.innerHTML = `
                <div style="text-align: center; color: white;">
                    <h3 style="margin-bottom: 20px;">${todoText}</h3>
                    <img src="${photoUrl}" style="max-width: 90vw; max-height: 80vh; border-radius: 10px;">
                    <p style="margin-top: 20px; opacity: 0.7;">Click anywhere to close</p>
                </div>
            `;
            
            modal.onclick = () => document.body.removeChild(modal);
            document.body.appendChild(modal);
        }
        
        // Add photo to existing todo
        function addPhotoToTodo(todoId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/jpeg';
            
            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                if (file.type !== 'image/jpeg') {
                    alert('Please select a JPEG image file.');
                    return;
                }
                
                const formData = new FormData();
                formData.append('photo', file);
                
                try {
                    const response = await fetch(`/api/todos/${todoId}/photo`, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (response.ok) {
                        loadTodos();
                    } else {
                        const error = await response.json();
                        alert('Failed to add photo: ' + (error.error || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Failed to add photo:', error);
                    alert('Failed to add photo');
                }
            };
            
            input.click();
        }
        
        // Delete photo from todo
        async function deletePhoto(todoId) {
            if (!confirm('Are you sure you want to remove this photo?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/todos/${todoId}/photo`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    loadTodos();
                } else {
                    alert('Failed to delete photo');
                }
            } catch (error) {
                console.error('Failed to delete photo:', error);
                alert('Failed to delete photo');
            }
        }
        
        function updateStats() {
            const total = todos.length;
            const completed = todos.filter(t => t.completed).length;
            const pending = total - completed;
            const progress = total > 0 ? Math.round((completed / total) * 100) : 0;
            
            document.getElementById('total-count').textContent = total;
            document.getElementById('completed-count').textContent = completed;
            document.getElementById('pending-count').textContent = pending;
            document.getElementById('progress-percent').textContent = `${progress}%`;
        }
        
        // Add enter key support for adding todos (handled by form submit)
    </script>
</body>
</html>